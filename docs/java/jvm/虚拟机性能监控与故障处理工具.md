# 虚拟机性能监控与故障处理工具
JDK 中bin目录下包含了许多工具，这些工具大多都由 tools.jar 中的功能封装得到。

## 1. 常用命令行工具
### 1.1 jps
功能类似 linux 的 ps，用于实时监控 JVM 进程信息。

#### 1.1.1 原理
JVM 启动后，会在 `java.io.tmpdir` 指定的临时文件目录下生成 `hsperfdata_{userName}` 文件夹，里面文件的名字就进程 pid，因此 jps 实际上就是列出这几个文件，或者根据参数解析显示这些文件里的对应信息。

#### 1.1.2 命令格式
```
jps [option] [hostid]
```
`hostid` 为 RMI 注册表中注册的主机名称，使用这个参数来查看远程虚拟机进程信息。

#### 1.1.3 参数选项
常用 option：
|option|功能|
|---|---|
|-l|输出完全的包名，应用主类名，如果执行的是 jar 包，输出jar包全路径名|
|-q|只输出 LVMID|
|-m|输出启动时传给 main 方法的参数|
|-v|输出虚拟机参数|

### 1.2 jstat
虚拟机统计信息监视工具，用于统计、监控虚拟机的运行状态。可以输出本地或远程虚拟机进程中的内存、垃圾收集、类装载、JIT相关信息等。

#### 1.2.1 命令格式
```
jstat [option vmid [interval [s | ms] [count]]]
```

需要注意后两个参数：
* `interval` 表示查询间隔
* `count` 表示查询次数

比如:
> jstat -gc 27464 500 20

表示每 500 毫秒输出一次 27464 虚拟机进程的垃圾回收状态，总共查询 20 次。

#### 1.2.2 参数选项
常用 option：
|option|功能|
|---|---|
|-class|显示类装载、卸载数量、总空间、类装载所耗费的时间|
|-gc|显示堆的状态|
|-gcutil|监控内容和 `-gc` 基本相同，但是显示的是已使用空间占总空间的百分比|
|-compiler|显示 JIT 编译器编译过的方法、耗时等信息|

最常用的是 `-gcutil`，大多数情况下排查内存相关问题会先用这个查看当前环境虚拟机堆的状态。

但如果环境可以导出 heapdump，那还是更推荐使用 VisualVM 等可视化工具分析堆状态。

### 1.3 jinfo
实时查看虚拟机启动参数（包括默认的未显式指定的参数），实时修改部分运行参数。

#### 1.3.1 命令格式
```
jinfo [option] vmid
```

#### 1.3.2 参数选项
|option|功能|
|---|---|
|-flag|直接接参数名是查询当前参数值，使用`+`/`-`描述是打开/关闭某些参数设置，使用 `key=value` 的格式是设置某些参数的值|
|-flags|显示所有参数|
||不带任何 option 是显示该进程的所有参数和所有系统属性|

最常用的还是 `-flag` 可以查看/修改指定系统参数的值。

### 1.4 jmap
内存映像工具，用于生成堆转储快照(即生成 heapdump 文件)。

#### 1.4.1 命令格式
```
jmap [option] vmid
```

#### 1.4.2 参数选项
|option|功能|
|---|---|
|-dump|生成 heapdump，后面还需要一些参数，完整格式为 `-dump:[live,]format=b, file=<filename>`，其中 `live` 参数表示只 dump 存活的对象|
|-heap|显示堆详细信息，包括使用的哪种垃圾收集器，堆相关参数配置，堆中分代的状态|
|-histo|显示堆中对象的统计信息，包括类名、实例数量、合计大小。因为对象由很多，实际使用时常配合 `head` 命令使用查看占用内存最多的对象|

### 1.5 jstack
堆栈跟踪工具，用于生成对应虚拟机当前时刻的线程快照（即 threaddump）。

#### 1.5.1 命令格式
```
jstack [option] vmid
```

#### 1.5.2 参数选项
|option|功能|
|---|---|
|-l| 除堆栈外，显示关于锁的附加信息|
|-F| 当正常输出请求未被响应时，强制输出线程堆栈|
|-m| 增加输出本地方法的 c/c++ 堆栈|

最常用的还是 `-l` 可以用于分析死锁。

## 2. 常用可视化工具
### 2.1 JConsole
是一个基于 JMX 的可视化监视、管理工具，在 JDK 的 bin 目录下。

### 2.2 VisualVM
比 JConsole 功能更强大，除了监控功能，还能 dump + 分析转储快照，也可以离线分析其他机器 dump 出来的快照信息。

自 JDK version 6 update 7 开始随 jdk 一起发布，也可以[单独下载使用](https://visualvm.github.io/)。

## 3. 常用第三方工具
### 3.1 Arthas
[Arthas](https://github.com/alibaba/arthas) 是Alibaba开源的Java诊断工具，是基于 Greys 二次开发而来，在线调试、监控、trace功能非常强大。

优点是开箱即用，不用额外写代码，也不用侵入修改原来的工程。

### 3.2 btrace
[btrace](https://github.com/btraceio/btrace) 是主要关注 dynamic tracing 的一个 jvm 监控工具。

基于字节码动态注入原理实现对运行中程序类、方法的监控。

缺点是需要写一些代码，使用起来不如 Arthas 方便。
