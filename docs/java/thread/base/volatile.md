# volatile 关键字
## 1. 实现原理
volatile 关键字主要有两个作用，**防止指令重排**和**保证变量可见性**。

### 1.1 保证可见性的原理
一句话概括：通过内存栅格（Memory Barrier）实现。
https://juejin.cn/post/6876395693854949389

CPU层面有三种内存栅格：
* Load Barrier
* Store Barrier
* Full Barrier
通过查看汇编代码，可以看到在对 volatile 修饰的变量进行写操作时，多了一个 lock 前缀的指令。
这个 lock 前缀的指令相对于一个完全的内存屏障指令，这个指令有两个效果：
* 将当前处理器缓存里缓存变量数据的缓存行（Cache Line）写回主存。
* 使其他缓存里对应的缓存行失效，需要重新从主存读取。

### 1.2 防止重排的原理
还是通过内存栅格（Memory Barrier）实现。
不过这里要提到的是编译器层面的内存栅格（上一节主要是处理器层面的内存栅格）。
JMM 层面的内存栅格分为四种：

## 2. 应用场景
要正确使用`volatile`关键字要满足3个条件：
* 对当前变量的写操作不依赖当前变量值。
* 该变量没有包含在具有其他变量的不变式中。
* 该变量的状态独立于其他内容。
