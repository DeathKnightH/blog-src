# 优化查询程序-MySQL
## 1. 优化查询程序的工作原理
查询优化主要手段有两个：
* 尽可能使用索引。
* 优先使用最严格的匹配条件。

尽可能使用索引好理解，具体可以查看《[索引-MySQL](./index.md)》部分。

优先使用最严格的匹配条件，可以在存在多个匹配条件时快速降低匹配搜索总数。举个例子：
```
SELECT name FROM students
WHERE age = 16 AND score = 100;
```

假设 students 表 age 和 score 字段都建有索引，score = 100 匹配到的行有 100 个，age = 16 匹配到的行有 1000 个，那么查询优化程序会先执行 score = 100 的匹配，后执行 age = 16 的匹配。

## 2. EXPLAIN 分析
使用 `EXPLAIN` 命令分析查询语句：
```
EXPLAIN statement
```

分析结果列表包含查询计划的一些指标，其中比较重要的有：
* key：实际会使用的索引。
* possible_key：候选索引。
* row：需要扫描的行数。
* type：表示如何从表中读取值，其中 `ALL` 表示全表扫描。
* select_type：表示查询类型，比如 `SIMPLE` 表示简单查询。

## 3. 基于查询优化程序原理的sql优化
### 3.1 分析索引使用情况
使用 `EXPLAIN` 分析查询语句索引使用情况，避免全表扫描。

### 3.2 定期执行 `ANALYSE` 语句
对于 InnoDB 和 MyISAM 引擎的数据库表，使用 `ANALYSE table_name` 可以让 MySQL 执行键值分布的统计分析，可以加快索引的比较效率。

### 3.3 改写默认的查询计划
* 索引：在查询语句的表名部分后加上 `FORCE INDEX`/`USE INDEX`/`IGNORE INDEX` 可以指定使用/忽略特定的索引。
* 表连接顺序：使用 `STRAIGHT_JOIN` 强制要求查询执行时表的扫描顺序。可以用在 `SELECT` 关键字和查询列之间，对所有连接生效，也可以用在 `FROM` 子句中，单独指定连接。

改写默认的查询计划不一定能提高查询效率，需要根据实际使用效果来判断。

### 3.4 优化表达式中的索引列
前面介绍索引的时候提到过索引列在算术表达式或者函数调用中被使用时会使索引失效，一个比较常见的解决方法是让索引列在表达式中单独出现，不参与计算，例如：

比较两个查询的条件子句，column1 列已建立了索引，优化前：
```
WHERE column1 * 2 > 100 # 索引失效
```

优化后：
```
WHERE column1 > 100 / 2 # 索引有效
```

### 3.5 避免滥用自动类型转换
比如比较一个字符串类型的数字，`column1` 字段类型是 `varchar`，并建立了前缀索引，优化前索引失效：
```
SELECT name FROM table_name 
WHERE column1 = 1004;
```

优化后使用索引：
```
SELECT name FROM table_name 
WHERE column1 = '1004';
```
