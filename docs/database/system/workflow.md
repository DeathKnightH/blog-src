# 数据库系统
## 1. 数据库组成
一个完整的关系数据库大致由以下5个部分组成：
- 存储管理器（transactional storage manager）

管理具体数据的存储、索引等，通常采用 B+ 树存储。
- 关系查询处理器（relational query processer）

解析/优化/鉴权 SQL 查询。
- 客户端/服务端通信管理器（client communications manager）

管理客户端和数据库的交互，处理客户端请求。
- 进程管理器（process manager）

负责管理和分配计算资源。
- 共享组件和工具（shared components and utilities）

一些在所有商用 DBMS 中都有的共享组件和工具，例如备份、监控、统计工具。

由于一个数据库系统涉及的模块太多，这里只记录比较重要的模块。

### 1.1 客户端管理器
用于处理客户端通信。

客户端通过客户端管理器访问数据库，此时通常客户端管理器有以下作用：
* 调用权限管理验证客户端权限
* 管理客户端连接
* 接收 SQL 请求，并交给 SQL 引擎处理
* 将获取的结果集返回给客户端

### 1.2 关系查询处理器
一条 SQL 语句进入引擎会经过 `解析`、`重写`、`优化`、`编译`，最后才会执行。
- 解析

输入的是原始的 SQL 语句，输出的是解析后的内部表示（通常是一个树型结构）。

解析过程会进行一系列的检查：
* 关键字是否正确
* 语法是否正确
* 数据库表、字段是否存在
* 运算类型是否正确
* 是否有权限读取/写入数据
- 重写

重写会进行一些预优化：
* 视图合并，将视图转换为对应的 SQL 查询。
* 删除冗余的Join。
* 子查询扁平化，尝试移除子查询，合并到主查询中。
* 计算常数并赋值。
- 优化

通常使用的是基于成本的优化（CBO）。
最终生成一个相对较优的查询计划。
- 编译

将查询计划编译为可执行的代码。
- 执行

执行代码，与数据管理器交互，获取/写入数据。

### 1.3 存储管理器
#### 1.3.1 缓存管理
- 缓存读

预读取，根据上一步的查询计划和统计监控可以预测查询需要磁盘上的哪些数据，在查询计算时就可以对磁盘中的数据进行预读取，读取到缓冲区中。

由于缓冲区不是无限大的，因此缓冲区中的数据需要经常刷新置换，而如果每次都清空缓冲区代价太大，因此需要有合适缓冲区置换算法来计算过期数据。

由一开始的 LRU (最近最少一次使用)到改进后对缓存数据加权的 LRU-K (最近最少k次使用)。
- 缓存写

避免多次进行磁盘写入，所以写入操作也会先记录在缓冲区，再一次性批量刷入磁盘。

#### 1.3.2 事务管理
##### 1.3.2.1 事务
ACID概念：
* Atomicity 原子性：一个事务是一个基本的工作单元，一个工作单元内操作要么全部成功，要么全部失败。
* Consistency 一致性：写入数据库的数据必须符合一致性约束。
* Isolation 隔离性：两个事务同时提交互不影响结果。
* Durability 持久性：事务一旦提交，数据修改是持久化生效的，即无论发生什么，改变都要保存到数据库。

##### 1.3.2.2 并发控制实现 ACI
实现原子性、一致性、隔离性的难点在于处理对同一条数据进行操作的多个事务。

针对这种并发问题有如下几种常见的解决方式：
- 读写锁

写操作加排他锁。

读操作加共享锁。

只有共享锁和共享锁不互斥，其他情况都是互斥的。
- 两段锁协议（Two-Phase Locking Protocol）

把事务分为两个阶段：
* 成长阶段：只能获取锁
* 收缩阶段：只能释放锁
- 乐观锁/版本控制

不使用独占锁，而是通过当前版本号来对比各个事务中对应的版本号，相同就提交事务，不相同就回滚。类似 CAS 操作。

- 死锁？

数据库处理死锁原理很简单，找到死锁，取消/回滚其中一个事务。

##### 1.3.2.3 日志管理实现 D
持久性要保证只要事务提交，数据就不会丢失。

造成这个问题的原因是数据库通常使用缓存来加速读写，而缓存是在系统内存中的，如果提交时断电/系统崩溃，内存中的数据就会丢失。

解决这个问题的一个办法是使用事务日志。

- 预写式日志（WAL）
  - 保证每个事务写入磁盘前都要先写日志
  - 保证每个事务的写入顺序与日志记录顺序相同
  - 保证事务提交成功前已经记入日志

当事务中进行一次修改操作时，经历以下5个步骤：
- 写入缓冲区
- 写入日志缓冲区
- 修改操作完成
- 从日志缓冲区写入日志文件
- 从缓冲区写入磁盘

当一个事务提交成功时通常是完成了4/5 步骤，此时修改操作是一定记入了日志的。

## 2. 一次 SQL 查询的流程
假设一个简单的查询场景，一个网络应用查询一个商品的库存数量：

1、应用调用JDBC等API与 DBMS 建立网络连接，将查询请求发送给 DBMS。
2、DBMS 的客户端管理器接收到查询请求，进程管理器为此请求分配一个空闲的计算线程。
3、计算线程中请求被传入关系查询处理器，经过鉴权/解析/优化/编译等流程，生成一个可执行的查询计划。
4、将查询计划提交给存储管理器，通过并发控制保证事务的 ACID 属性，获取正确的库存数据。如果此查询还包括了其他修改操作，还需要写入事务日志。
5、事务提交后将结果刷新到缓存（根据缓存策略不同），结果返回给关系查询处理器。
6、关系查询处理器将结果组装成结果集，交由客户端管理器发送给客户端。
